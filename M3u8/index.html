<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M3U8 Parser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background-color: #0d0d0d;
      color: #ffffff;
      font-family: 'Segoe UI', sans-serif;
      padding: 2rem;
    }

    h1 {
      font-size: 2rem;
      font-weight: 500;
      text-align: center;
      margin-bottom: 1rem;
    }

    .input-group {
      max-width: 800px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input {
      padding: 12px;
      background-color: #1a1a1a;
      border: 1px solid #333;
      color: white;
      font-size: 1rem;
      border-radius: 6px;
    }

    button {
      padding: 12px;
      background-color: #00ff88;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #00cc6f;
    }

    #result {
      margin-top: 2rem;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #1a1a1a;
      margin-top: 1rem;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #333;
    }

    th {
      background-color: #111;
    }

    .btn-small {
      font-size: 0.9rem;
      padding: 6px 10px;
      border-radius: 4px;
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-right: 4px;
    }

    .btn-small:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <h1>M3U8 Variant Stream Parser</h1>
  <div class="input-group">
    <input type="text" id="url" placeholder="Enter M3U8 URL">
    <input type="text" id="auth" placeholder="Authorization Header (Optional)">
    <button onclick="parseM3U8()">Parse M3U8</button>
  </div>

  <div id="result"></div>

  <script>
    async function parseM3U8() {
      const url = document.getElementById('url').value.trim();
      const auth = document.getElementById('auth').value.trim();
      const result = document.getElementById('result');
      result.innerHTML = 'Parsing...';

      const endpoint = 'https://m3u8-xvpf.onrender.com/M3u8/m3u8-parser.php';

      try {
        const res = await fetch(`${endpoint}?url=${encodeURIComponent(url)}&auth=${encodeURIComponent(auth)}`);
        if (!res.ok) throw new Error('Fetch failed: ' + res.status);
        const data = await res.json();

        if (data.error) {
          result.innerHTML = `<p style="color:red;">${data.error}</p>`;
          return;
        }

        const variants = data.streams || [];
        if (variants.length === 0) {
          result.innerHTML = '<p>No variant streams found.</p>';
          return;
        }

        let html = `<table><thead>
          <tr>
            <th>Resolution</th>
            <th>Bandwidth</th>
            <th>Codec</th>
            <th>Actions</th>
          </tr></thead><tbody>`;

        const m3uData = ['#EXTM3U', '#EXT-X-VERSION:3', '#EXT-X-INDEPENDENT-SEGMENTS'];

        variants.forEach(v => {
          m3uData.push(`#EXT-X-STREAM-INF:BANDWIDTH=${v.bw},CODECS="${v.codec}",RESOLUTION=${v.res}`);
          m3uData.push(v.url);

          html += `<tr>
            <td>${v.res}</td>
            <td>${(v.bw / 1000).toFixed(0)} kbps</td>
            <td>${v.codec}</td>
            <td>
              <button class="btn-small" onclick="window.open('player.html?src=${encodeURIComponent(v.url)}')">Play</button>
              <button class="btn-small" onclick="navigator.clipboard.writeText('${v.url}')">Copy</button>
            </td>
          </tr>`;
        });

        html += '</tbody></table>';
        html += `<br><button onclick="exportM3U()">Download as .m3u</button>`;
        result.innerHTML = html;

        // store for export
        window.__M3U_EXPORT = m3uData.join('\n');

      } catch (err) {
        result.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }

    function exportM3U() {
      const content = window.__M3U_EXPORT || '';
      const blob = new Blob([content], { type: 'audio/x-mpegurl' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'playlist.m3u';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
